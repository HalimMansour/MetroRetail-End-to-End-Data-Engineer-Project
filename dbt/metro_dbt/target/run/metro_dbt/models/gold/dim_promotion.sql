
  
    USE [MetroRetailDB];
    USE [MetroRetailDB];
    
    

    

    
    USE [MetroRetailDB];
    EXEC('
        create view "Gold"."dim_promotion__dbt_tmp__dbt_tmp_vw" as 

/*
    Gold Model: Promotion Dimension (SIMPLIFIED)
    Source: Silver.mkt_promotions_clean
    Target: Gold.dim_promotion
    
    Memory optimized - direct pass-through from Silver
*/

SELECT
    -- Promotion_Key will be auto-generated by SQL Server IDENTITY
    Promotion_ID,
    Promo_Name,
    Promo_Type,
    Start_Date,
    End_Date,
    Promo_Cost,
    Eligible_SKUs,  -- Keep for product-promotion analysis
    
    -- Metadata
    DQ_Score,
    GETDATE() AS Created_TS,
    GETDATE() AS Updated_TS
    
FROM "MetroRetailDB"."Silver"."mkt_promotions_clean"
WHERE Is_Valid = 1

/*
    Output Schema:
    - Promotion_Key: INT - Surrogate key (auto-generated)
    - Promotion_ID: VARCHAR(50)
    - Promo_Name: VARCHAR(255)
    - Promo_Type: VARCHAR(50)
    - Start_Date: DATE
    - End_Date: DATE
    - Promo_Cost: DECIMAL(18,2)
    - Eligible_SKUs: NVARCHAR(MAX)
    - DQ_Score: INT
    - Created_TS: DATETIME2
    - Updated_TS: DATETIME2
*/;
    ')

EXEC('
            SELECT * INTO "MetroRetailDB"."Gold"."dim_promotion__dbt_tmp" FROM "MetroRetailDB"."Gold"."dim_promotion__dbt_tmp__dbt_tmp_vw" 
    OPTION (LABEL = ''dbt-sqlserver'');

        ')

    
    EXEC('DROP VIEW IF EXISTS Gold.dim_promotion__dbt_tmp__dbt_tmp_vw')



    
    use [MetroRetailDB];
    if EXISTS (
        SELECT *
        FROM sys.indexes with (nolock)
        WHERE name = 'Gold_dim_promotion__dbt_tmp_cci'
        AND object_id=object_id('Gold_dim_promotion__dbt_tmp')
    )
    DROP index "Gold"."dim_promotion__dbt_tmp".Gold_dim_promotion__dbt_tmp_cci
    CREATE CLUSTERED COLUMNSTORE INDEX Gold_dim_promotion__dbt_tmp_cci
    ON "Gold"."dim_promotion__dbt_tmp"

   


  