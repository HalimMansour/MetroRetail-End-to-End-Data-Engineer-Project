
  
    USE [MetroRetailDB];
    USE [MetroRetailDB];
    
    

    

    
    USE [MetroRetailDB];
    EXEC('
        create view "Gold"."dim_product__dbt_tmp__dbt_tmp_vw" as 

/*
    Gold Model: Product Dimension
    Source: Silver.erp_products_clean
    Target: Gold.dim_product

    Maintains SCD Type 2 from Silver layer
    Provides product master for fact_sales joins
    
    Business Rules:
    - Preserves SCD Type 2 structure
    - Product_Key is surrogate key (auto-generated)
    - Product_SKU is natural key
*/

WITH source AS (
    SELECT *
    FROM "MetroRetailDB"."Silver"."erp_products_clean"
    WHERE Is_Valid = 1
),

final AS (
    SELECT
        -- Product_Key will be auto-generated by SQL Server IDENTITY
        Product_SKU,
        Product_Name,
        Category,
        Sub_Category,
        Price,
        Cost_Price,
        Supplier_ID,
        
        -- SCD Type 2 fields
        Effective_From,
        Effective_To,
        Is_Current,
        Version_Number,
        
        -- Metadata
        DQ_Score,
        GETDATE() AS Created_TS,
        GETDATE() AS Updated_TS
        
    FROM source
)

SELECT * FROM final

/*
    Output Schema:
    - Product_Key: INT - Surrogate key (auto-generated)
    - Product_SKU: VARCHAR(50) - Natural key
    - Product_Name: VARCHAR(255)
    - Category: VARCHAR(100)
    - Sub_Category: VARCHAR(100)
    - Price: DECIMAL(18,2)
    - Cost_Price: DECIMAL(18,2)
    - Supplier_ID: VARCHAR(50)
    - Effective_From: DATE
    - Effective_To: DATE
    - Is_Current: BIT
    - Version_Number: INT
    - DQ_Score: INT
    - Created_TS: DATETIME2
    - Updated_TS: DATETIME2
    
    Note: Margin_Amount and Margin_Pct are computed columns in SQL Server
*/;
    ')

EXEC('
            SELECT * INTO "MetroRetailDB"."Gold"."dim_product__dbt_tmp" FROM "MetroRetailDB"."Gold"."dim_product__dbt_tmp__dbt_tmp_vw" 
    OPTION (LABEL = ''dbt-sqlserver'');

        ')

    
    EXEC('DROP VIEW IF EXISTS Gold.dim_product__dbt_tmp__dbt_tmp_vw')



    
    use [MetroRetailDB];
    if EXISTS (
        SELECT *
        FROM sys.indexes with (nolock)
        WHERE name = 'Gold_dim_product__dbt_tmp_cci'
        AND object_id=object_id('Gold_dim_product__dbt_tmp')
    )
    DROP index "Gold"."dim_product__dbt_tmp".Gold_dim_product__dbt_tmp_cci
    CREATE CLUSTERED COLUMNSTORE INDEX Gold_dim_product__dbt_tmp_cci
    ON "Gold"."dim_product__dbt_tmp"

   


  