

/*
    Gold Model: Weather Dimension
    Source: Silver.api_weather_clean
    Target: Gold.dim_weather

    Weather data for weather-sales correlation analysis
    Grain: One row per Weather_Date + Store_ID
    
    Business Rules:
    - Weather_Key is surrogate key (auto-generated)
    - Weather_Date + Store_ID is natural key
    - Temperature can be NULL (~2% expected)
*/

WITH source AS (
    SELECT *
    FROM "MetroRetailDB"."Silver"."api_weather_clean"
    WHERE Is_Valid = 1
),

final AS (
    SELECT
        -- Weather_Key will be auto-generated by SQL Server IDENTITY
        Weather_Date,
        Store_ID,
        Temperature_C,
        Precipitation_mm,
        Weather_Condition,
        
        -- Business flags
        Has_Missing_Temperature,
        Is_Extreme_Temperature,
        
        -- Metadata
        DQ_Score,
        GETDATE() AS Created_TS,
        GETDATE() AS Updated_TS
        
    FROM source
)

SELECT * FROM final

/*
    Output Schema:
    - Weather_Key: INT - Surrogate key (auto-generated)
    - Weather_Date: DATE - Natural key (part 1)
    - Store_ID: VARCHAR(50) - Natural key (part 2)
    - Temperature_C: DECIMAL(5,2) - Can be NULL
    - Precipitation_mm: DECIMAL(5,2)
    - Weather_Condition: VARCHAR(100)
    - Has_Missing_Temperature: BIT
    - Is_Extreme_Temperature: BIT
    - DQ_Score: INT
    - Created_TS: DATETIME2
    - Updated_TS: DATETIME2
    
    Note: Is_Rainy is computed column in SQL Server (Precipitation_mm > 0)
    
    Usage in Analysis:
    - Join to fact_sales on Transaction_Date + Store_ID
    - Analyze sales by weather condition
    - Track impact of extreme weather on store performance
*/