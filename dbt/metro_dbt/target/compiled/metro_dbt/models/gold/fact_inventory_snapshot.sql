

/*
    Gold Model: Inventory Snapshot Fact Table
    Source: Silver.erp_inventory_clean
    Target: Gold.fact_inventory_snapshot

    Periodic Snapshot Fact Table
    Grain: One row per Product_SKU + Store_ID + Snapshot_Date
    
    Fact Type: ADDITIVE measures (can sum across all dimensions)
    
    Business Rules:
    - Latest snapshot per Product + Store combination
    - Negative quantities already excluded in Silver
    - Supports inventory trend analysis over time
*/

WITH source AS (
    SELECT *
    FROM "MetroRetailDB"."Silver"."erp_inventory_clean"
    WHERE Is_Valid = 1
),

final AS (
    SELECT
        -- Inventory_Snapshot_Key will be auto-generated by SQL Server IDENTITY
        
        -- Natural Keys (for dimension joins)
        Inventory_ID,
        Product_SKU,
        Store_ID,
        Snapshot_Date,
        
        -- Measures (ADDITIVE - can sum across dimensions)
        Quantity_On_Hand,
        Reorder_Level,
        
        -- Derived Measures
        CASE 
            WHEN Quantity_On_Hand < Reorder_Level 
            THEN Reorder_Level - Quantity_On_Hand 
            ELSE 0 
        END AS Reorder_Quantity_Needed,
        
        -- Degenerate Dimensions (attributes stored in fact)
        -- None needed - all attributes in proper dimensions
        
        -- Business Flags
        Is_Below_Reorder_Level,
        Is_Outlier_Quantity,
        
        -- Metadata
        DQ_Score,
        GETDATE() AS Created_TS,
        GETDATE() AS Updated_TS
        
    FROM source
)

SELECT * FROM final

/*
    Output Schema:
    - Inventory_Snapshot_Key: INT - Surrogate key (auto-generated)
    - Inventory_ID: VARCHAR(50) - Business key
    - Product_SKU: VARCHAR(50) - FK to dim_product (natural key)
    - Store_ID: VARCHAR(50) - FK to dim_store (natural key)
    - Snapshot_Date: DATE - FK to dim_date
    - Quantity_On_Hand: INT - MEASURE (additive)
    - Reorder_Level: INT - MEASURE (semi-additive, current value)
    - Reorder_Quantity_Needed: INT - MEASURE (additive)
    - Is_Below_Reorder_Level: BIT - FLAG
    - Is_Outlier_Quantity: BIT - FLAG
    - DQ_Score: INT
    - Created_TS: DATETIME2
    - Updated_TS: DATETIME2
    
    Grain:
    One row per Product + Store + Snapshot Date
    
    Fact Type:
    PERIODIC SNAPSHOT - captures state at regular intervals
    
    Analysis Examples:
    
    1. Total inventory by store:
       SELECT Store_ID, SUM(Quantity_On_Hand) AS Total_Inventory
       FROM fact_inventory_snapshot
       GROUP BY Store_ID;
    
    2. Products needing reorder:
       SELECT Product_SKU, Store_ID, Reorder_Quantity_Needed
       FROM fact_inventory_snapshot
       WHERE Is_Below_Reorder_Level = 1;
    
    3. Inventory trends over time:
       SELECT 
           Snapshot_Date,
           Product_SKU,
           Quantity_On_Hand,
           LAG(Quantity_On_Hand) OVER (
               PARTITION BY Product_SKU, Store_ID 
               ORDER BY Snapshot_Date
           ) AS Previous_Quantity
       FROM fact_inventory_snapshot;
    
    4. Join with dimensions:
       SELECT 
           d.Year_Month,
           s.Store_Name,
           p.Category,
           SUM(f.Quantity_On_Hand) AS Total_Inventory,
           SUM(f.Reorder_Quantity_Needed) AS Total_Reorder_Needed
       FROM fact_inventory_snapshot f
       INNER JOIN dim_date d ON f.Snapshot_Date = d.Date_Value
       INNER JOIN dim_store s ON f.Store_ID = s.Store_ID
       INNER JOIN dim_product p ON f.Product_SKU = p.Product_SKU AND p.Is_Current = 1
       GROUP BY d.Year_Month, s.Store_Name, p.Category;
*/