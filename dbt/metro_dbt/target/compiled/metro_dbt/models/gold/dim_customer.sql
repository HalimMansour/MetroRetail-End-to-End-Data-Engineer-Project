

/*
    Gold Model: Customer Dimension
    Source: Silver.crm_customers_clean
    Target: Gold.dim_customer

    Provides customer master for fact_sales joins
    PII already masked in Silver layer
    
    Business Rules:
    - Customer_Key is surrogate key (auto-generated)
    - Customer_ID is natural key
    - One row per customer
*/

WITH source AS (
    SELECT *
    FROM "MetroRetailDB"."Silver"."crm_customers_clean"
    WHERE Is_Valid = 1
),

final AS (
    SELECT
        -- Customer_Key will be auto-generated by SQL Server IDENTITY
        Customer_ID,
        Full_Name,
        Gender,
        Birthdate,
        Registration_Date,
        Email AS Email,  -- Already masked in Silver
        Phone_Number AS Phone_Number,  -- Already masked in Silver
        City,
        Preferred_Channel,
        
        -- Metadata
        DQ_Score,
        GETDATE() AS Created_TS,
        GETDATE() AS Updated_TS
        
    FROM source
)

SELECT * FROM final

/*
    Output Schema:
    - Customer_Key: INT - Surrogate key (auto-generated)
    - Customer_ID: VARCHAR(50) - Natural key
    - Full_Name: VARCHAR(255)
    - Gender: CHAR(1)
    - Birthdate: DATE
    - Registration_Date: DATE
    - Email_Masked: VARCHAR(255)
    - Phone_Masked: VARCHAR(50)
    - City: VARCHAR(100)
    - Preferred_Channel: VARCHAR(20)
    - DQ_Score: INT
    - Created_TS: DATETIME2
    - Updated_TS: DATETIME2
    
    Note: Age and Customer_Tenure_Days are computed columns in SQL Server
*/