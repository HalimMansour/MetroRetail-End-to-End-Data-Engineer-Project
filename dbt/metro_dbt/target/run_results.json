{"metadata": {"dbt_schema_version": "https://schemas.getdbt.com/dbt/run-results/v6.json", "dbt_version": "1.10.15", "generated_at": "2025-12-31T05:45:27.722508Z", "invocation_id": "1d81c5f0-6ea2-4caf-b728-ddb9a51d9223", "invocation_started_at": "2025-12-31T05:42:38.095892Z", "env": {}}, "results": [{"status": "error", "timing": [{"name": "compile", "started_at": "2025-12-31T05:42:40.587014Z", "completed_at": "2025-12-31T05:42:40.622996Z"}, {"name": "execute", "started_at": "2025-12-31T05:42:40.637808Z", "completed_at": "2025-12-31T05:43:06.140219Z"}], "thread_id": "Thread-4 (worker)", "execution_time": 25.678600072860718, "adapter_response": {}, "message": "('42000', \"[42000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]A timeout occurred while waiting for memory resources to execute the query in resource pool 'internal' (1). Rerun the query. (8645) (SQLMoreResults); [42000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)\")", "failures": null, "unique_id": "model.metro_dbt.dim_product", "compiled": true, "compiled_code": "\n\n/*\n    Gold Model: Product Dimension\n    Source: Silver.erp_products_clean\n    Target: Gold.dim_product\n\n    Maintains SCD Type 2 from Silver layer\n    Provides product master for fact_sales joins\n    \n    Business Rules:\n    - Preserves SCD Type 2 structure\n    - Product_Key is surrogate key (auto-generated)\n    - Product_SKU is natural key\n*/\n\nWITH source AS (\n    SELECT *\n    FROM \"MetroRetailDB\".\"Silver\".\"erp_products_clean\"\n    WHERE Is_Valid = 1\n),\n\nfinal AS (\n    SELECT\n        -- Product_Key will be auto-generated by SQL Server IDENTITY\n        Product_SKU,\n        Product_Name,\n        Category,\n        Sub_Category,\n        Price,\n        Cost_Price,\n        Supplier_ID,\n        \n        -- SCD Type 2 fields\n        Effective_From,\n        Effective_To,\n        Is_Current,\n        Version_Number,\n        \n        -- Metadata\n        DQ_Score,\n        GETDATE() AS Created_TS,\n        GETDATE() AS Updated_TS\n        \n    FROM source\n)\n\nSELECT * FROM final\n\n/*\n    Output Schema:\n    - Product_Key: INT - Surrogate key (auto-generated)\n    - Product_SKU: VARCHAR(50) - Natural key\n    - Product_Name: VARCHAR(255)\n    - Category: VARCHAR(100)\n    - Sub_Category: VARCHAR(100)\n    - Price: DECIMAL(18,2)\n    - Cost_Price: DECIMAL(18,2)\n    - Supplier_ID: VARCHAR(50)\n    - Effective_From: DATE\n    - Effective_To: DATE\n    - Is_Current: BIT\n    - Version_Number: INT\n    - DQ_Score: INT\n    - Created_TS: DATETIME2\n    - Updated_TS: DATETIME2\n    \n    Note: Margin_Amount and Margin_Pct are computed columns in SQL Server\n*/", "relation_name": "\"MetroRetailDB\".\"Gold\".\"dim_product\"", "batch_results": null}, {"status": "error", "timing": [{"name": "compile", "started_at": "2025-12-31T05:42:40.613995Z", "completed_at": "2025-12-31T05:42:40.637808Z"}, {"name": "execute", "started_at": "2025-12-31T05:42:40.637808Z", "completed_at": "2025-12-31T05:43:06.148390Z"}], "thread_id": "Thread-6 (worker)", "execution_time": 25.647574186325073, "adapter_response": {}, "message": "('42000', \"[42000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]A timeout occurred while waiting for memory resources to execute the query in resource pool 'internal' (1). Rerun the query. (8645) (SQLMoreResults); [42000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)\")", "failures": null, "unique_id": "model.metro_dbt.dim_store", "compiled": true, "compiled_code": "\n\n/*\n    Gold Model: Store Dimension\n    Source: Silver.erp_stores_clean\n    Target: Gold.dim_store\n\n    Provides store master for fact_sales joins\n    \n    Business Rules:\n    - Store_Key is surrogate key (auto-generated)\n    - Store_ID is natural key\n    - One row per store\n*/\n\nWITH source AS (\n    SELECT *\n    FROM \"MetroRetailDB\".\"Silver\".\"erp_stores_clean\"\n    WHERE Is_Valid = 1\n),\n\nfinal AS (\n    SELECT\n        -- Store_Key will be auto-generated by SQL Server IDENTITY\n        Store_ID,\n        Store_Name,\n        City,\n        Region,\n        Store_Manager,\n        Store_Area_sqm,\n        Open_Date,\n        \n        -- Metadata\n        DQ_Score,\n        GETDATE() AS Created_TS,\n        GETDATE() AS Updated_TS\n        \n    FROM source\n)\n\nSELECT * FROM final\n\n/*\n    Output Schema:\n    - Store_Key: INT - Surrogate key (auto-generated)\n    - Store_ID: VARCHAR(50) - Natural key\n    - Store_Name: VARCHAR(255)\n    - City: VARCHAR(100)\n    - Region: VARCHAR(100)\n    - Store_Manager: VARCHAR(255)\n    - Store_Area_sqm: DECIMAL(10,2)\n    - Open_Date: DATE\n    - DQ_Score: INT\n    - Created_TS: DATETIME2\n    - Updated_TS: DATETIME2\n    \n    Note: Store_Age_Years is computed column in SQL Server\n*/", "relation_name": "\"MetroRetailDB\".\"Gold\".\"dim_store\"", "batch_results": null}, {"status": "error", "timing": [{"name": "compile", "started_at": "2025-12-31T05:42:40.608487Z", "completed_at": "2025-12-31T05:42:40.637808Z"}, {"name": "execute", "started_at": "2025-12-31T05:42:40.637808Z", "completed_at": "2025-12-31T05:43:06.145782Z"}], "thread_id": "Thread-5 (worker)", "execution_time": 25.67384433746338, "adapter_response": {}, "message": "('42000', \"[42000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]A timeout occurred while waiting for memory resources to execute the query in resource pool 'internal' (1). Rerun the query. (8645) (SQLMoreResults); [42000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)\")", "failures": null, "unique_id": "model.metro_dbt.dim_promotion", "compiled": true, "compiled_code": "\n\n/*\n    Gold Model: Promotion Dimension (SIMPLIFIED)\n    Source: Silver.mkt_promotions_clean\n    Target: Gold.dim_promotion\n    \n    Memory optimized - direct pass-through from Silver\n*/\n\nSELECT\n    -- Promotion_Key will be auto-generated by SQL Server IDENTITY\n    Promotion_ID,\n    Promo_Name,\n    Promo_Type,\n    Start_Date,\n    End_Date,\n    Promo_Cost,\n    Eligible_SKUs,  -- Keep for product-promotion analysis\n    \n    -- Metadata\n    DQ_Score,\n    GETDATE() AS Created_TS,\n    GETDATE() AS Updated_TS\n    \nFROM \"MetroRetailDB\".\"Silver\".\"mkt_promotions_clean\"\nWHERE Is_Valid = 1\n\n/*\n    Output Schema:\n    - Promotion_Key: INT - Surrogate key (auto-generated)\n    - Promotion_ID: VARCHAR(50)\n    - Promo_Name: VARCHAR(255)\n    - Promo_Type: VARCHAR(50)\n    - Start_Date: DATE\n    - End_Date: DATE\n    - Promo_Cost: DECIMAL(18,2)\n    - Eligible_SKUs: NVARCHAR(MAX)\n    - DQ_Score: INT\n    - Created_TS: DATETIME2\n    - Updated_TS: DATETIME2\n*/", "relation_name": "\"MetroRetailDB\".\"Gold\".\"dim_promotion\"", "batch_results": null}, {"status": "error", "timing": [{"name": "compile", "started_at": "2025-12-31T05:42:40.632995Z", "completed_at": "2025-12-31T05:42:40.637808Z"}, {"name": "execute", "started_at": "2025-12-31T05:42:40.658402Z", "completed_at": "2025-12-31T05:43:17.072493Z"}], "thread_id": "Thread-8 (worker)", "execution_time": 36.48836541175842, "adapter_response": {}, "message": "('42000', \"[42000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]A timeout occurred while waiting for memory resources to execute the query in resource pool 'internal' (1). Rerun the query. (8645) (SQLMoreResults); [42000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)\")", "failures": null, "unique_id": "model.metro_dbt.fact_inventory_snapshot", "compiled": true, "compiled_code": "\n\n/*\n    Gold Model: Inventory Snapshot Fact Table\n    Source: Silver.erp_inventory_clean\n    Target: Gold.fact_inventory_snapshot\n\n    Periodic Snapshot Fact Table\n    Grain: One row per Product_SKU + Store_ID + Snapshot_Date\n    \n    Fact Type: ADDITIVE measures (can sum across all dimensions)\n    \n    Business Rules:\n    - Latest snapshot per Product + Store combination\n    - Negative quantities already excluded in Silver\n    - Supports inventory trend analysis over time\n*/\n\nWITH source AS (\n    SELECT *\n    FROM \"MetroRetailDB\".\"Silver\".\"erp_inventory_clean\"\n    WHERE Is_Valid = 1\n),\n\nfinal AS (\n    SELECT\n        -- Inventory_Snapshot_Key will be auto-generated by SQL Server IDENTITY\n        \n        -- Natural Keys (for dimension joins)\n        Inventory_ID,\n        Product_SKU,\n        Store_ID,\n        Snapshot_Date,\n        \n        -- Measures (ADDITIVE - can sum across dimensions)\n        Quantity_On_Hand,\n        Reorder_Level,\n        \n        -- Derived Measures\n        CASE \n            WHEN Quantity_On_Hand < Reorder_Level \n            THEN Reorder_Level - Quantity_On_Hand \n            ELSE 0 \n        END AS Reorder_Quantity_Needed,\n        \n        -- Degenerate Dimensions (attributes stored in fact)\n        -- None needed - all attributes in proper dimensions\n        \n        -- Business Flags\n        Is_Below_Reorder_Level,\n        Is_Outlier_Quantity,\n        \n        -- Metadata\n        DQ_Score,\n        GETDATE() AS Created_TS,\n        GETDATE() AS Updated_TS\n        \n    FROM source\n)\n\nSELECT * FROM final\n\n/*\n    Output Schema:\n    - Inventory_Snapshot_Key: INT - Surrogate key (auto-generated)\n    - Inventory_ID: VARCHAR(50) - Business key\n    - Product_SKU: VARCHAR(50) - FK to dim_product (natural key)\n    - Store_ID: VARCHAR(50) - FK to dim_store (natural key)\n    - Snapshot_Date: DATE - FK to dim_date\n    - Quantity_On_Hand: INT - MEASURE (additive)\n    - Reorder_Level: INT - MEASURE (semi-additive, current value)\n    - Reorder_Quantity_Needed: INT - MEASURE (additive)\n    - Is_Below_Reorder_Level: BIT - FLAG\n    - Is_Outlier_Quantity: BIT - FLAG\n    - DQ_Score: INT\n    - Created_TS: DATETIME2\n    - Updated_TS: DATETIME2\n    \n    Grain:\n    One row per Product + Store + Snapshot Date\n    \n    Fact Type:\n    PERIODIC SNAPSHOT - captures state at regular intervals\n    \n    Analysis Examples:\n    \n    1. Total inventory by store:\n       SELECT Store_ID, SUM(Quantity_On_Hand) AS Total_Inventory\n       FROM fact_inventory_snapshot\n       GROUP BY Store_ID;\n    \n    2. Products needing reorder:\n       SELECT Product_SKU, Store_ID, Reorder_Quantity_Needed\n       FROM fact_inventory_snapshot\n       WHERE Is_Below_Reorder_Level = 1;\n    \n    3. Inventory trends over time:\n       SELECT \n           Snapshot_Date,\n           Product_SKU,\n           Quantity_On_Hand,\n           LAG(Quantity_On_Hand) OVER (\n               PARTITION BY Product_SKU, Store_ID \n               ORDER BY Snapshot_Date\n           ) AS Previous_Quantity\n       FROM fact_inventory_snapshot;\n    \n    4. Join with dimensions:\n       SELECT \n           d.Year_Month,\n           s.Store_Name,\n           p.Category,\n           SUM(f.Quantity_On_Hand) AS Total_Inventory,\n           SUM(f.Reorder_Quantity_Needed) AS Total_Reorder_Needed\n       FROM fact_inventory_snapshot f\n       INNER JOIN dim_date d ON f.Snapshot_Date = d.Date_Value\n       INNER JOIN dim_store s ON f.Store_ID = s.Store_ID\n       INNER JOIN dim_product p ON f.Product_SKU = p.Product_SKU AND p.Is_Current = 1\n       GROUP BY d.Year_Month, s.Store_Name, p.Category;\n*/", "relation_name": "\"MetroRetailDB\".\"Gold\".\"fact_inventory_snapshot\"", "batch_results": null}, {"status": "error", "timing": [{"name": "compile", "started_at": "2025-12-31T05:42:40.511532Z", "completed_at": "2025-12-31T05:42:40.537555Z"}, {"name": "execute", "started_at": "2025-12-31T05:42:40.542566Z", "completed_at": "2025-12-31T05:43:37.155476Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 56.66177749633789, "adapter_response": {}, "message": "('42000', \"[42000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]A timeout occurred while waiting for memory resources to execute the query in resource pool 'internal' (1). Rerun the query. (8645) (SQLMoreResults); [42000] [Microsoft][ODBC Driver 17 for SQL Server][SQL Server]The statement has been terminated. (3621)\")", "failures": null, "unique_id": "model.metro_dbt.bridge_promotion_product", "compiled": true, "compiled_code": "\n\n/*\n    Gold Model: Promotion-Product Bridge Table\n    Source: Silver.mkt_promotions_clean + Silver.erp_products_clean\n    Target: Gold.bridge_promotion_product\n\n    APPROACH: Use natural keys (Promotion_ID, Product_SKU) \n    Then join to dimensions in a view or Power BI\n    \n    Handles:\n    - \"P0047|P0133|P0177|P0067|P0114\" \u2192 5 rows\n    - \"P0189\" \u2192 1 row\n    - \"N/A\" \u2192 No rows (store-level promo)\n*/\n\nWITH promotions AS (\n    SELECT \n        Promotion_ID,\n        Promo_Name,\n        Eligible_SKUs,\n        Start_Date,\n        End_Date\n    FROM \"MetroRetailDB\".\"Silver\".\"mkt_promotions_clean\"\n    WHERE Is_Valid = 1\n        AND Eligible_SKUs IS NOT NULL \n        AND Eligible_SKUs <> 'N/A'  -- Exclude store-level promos\n),\n\n-- Parse pipe-separated SKUs into individual rows\nparsed_skus AS (\n    SELECT \n        p.Promotion_ID,\n        p.Promo_Name,\n        p.Start_Date,\n        p.End_Date,\n        UPPER(LTRIM(RTRIM(value))) AS Product_SKU\n    FROM promotions p\n    CROSS APPLY STRING_SPLIT(p.Eligible_SKUs, '|')\n    WHERE LTRIM(RTRIM(value)) <> ''  -- Exclude empty strings\n),\n\n-- Validate that products exist\nwith_validation AS (\n    SELECT \n        ps.Promotion_ID,\n        ps.Promo_Name,\n        ps.Start_Date,\n        ps.End_Date,\n        ps.Product_SKU\n    FROM parsed_skus ps\n    WHERE EXISTS (\n        SELECT 1 \n        FROM \"MetroRetailDB\".\"Silver\".\"erp_products_clean\" pr \n        WHERE pr.Product_SKU = ps.Product_SKU \n            AND pr.Is_Current = 1\n            AND pr.Is_Valid = 1\n    )\n),\n\nfinal AS (\n    SELECT \n        Promotion_ID,\n        Product_SKU,\n        GETDATE() AS Created_TS\n    FROM with_validation\n)\n\nSELECT * FROM final\n\n/*\n    Output Schema:\n    - Promotion_ID: VARCHAR(50) - Natural key\n    - Product_SKU: VARCHAR(50) - Natural key\n    - Created_TS: DATETIME2\n    \n    Example Transformation:\n    \n    Input (mkt_promotions_clean):\n    Promotion_ID | Eligible_SKUs\n    PROMO001     | P0047|P0133|P0177\n    PROMO002     | P0189\n    PROMO003     | N/A\n    \n    Output (bridge_promotion_product):\n    Promotion_ID | Product_SKU\n    PROMO001     | P0047\n    PROMO001     | P0133\n    PROMO001     | P0177\n    PROMO002     | P0189\n    (no row for PROMO003 because Eligible_SKUs = 'N/A')\n    \n    Usage Options:\n    \n    Option 1 - Direct Join in SQL:\n    SELECT \n        p.Promo_Name,\n        pr.Product_Name,\n        pr.Category\n    FROM Gold.bridge_promotion_product b\n    INNER JOIN Gold.dim_promotion p ON b.Promotion_ID = p.Promotion_ID\n    INNER JOIN Gold.dim_product pr ON b.Product_SKU = pr.Product_SKU AND pr.Is_Current = 1;\n    \n    Option 2 - Create view with surrogate keys:\n    CREATE VIEW Gold.vw_bridge_promotion_product AS\n    SELECT \n        p.Promotion_Key,\n        pr.Product_Key,\n        b.Created_TS\n    FROM Gold.bridge_promotion_product b\n    INNER JOIN Gold.dim_promotion p ON b.Promotion_ID = p.Promotion_ID\n    INNER JOIN Gold.dim_product pr ON b.Product_SKU = pr.Product_SKU AND pr.Is_Current = 1;\n    \n    Option 3 - Power BI Relationships:\n    bridge[Promotion_ID] \u2192 dim_promotion[Promotion_ID]\n    bridge[Product_SKU] \u2192 dim_product[Product_SKU]\n*/", "relation_name": "\"MetroRetailDB\".\"Gold\".\"bridge_promotion_product\"", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-12-31T05:42:40.579692Z", "completed_at": "2025-12-31T05:42:40.611996Z"}, {"name": "execute", "started_at": "2025-12-31T05:42:40.628996Z", "completed_at": "2025-12-31T05:44:54.101344Z"}], "thread_id": "Thread-3 (worker)", "execution_time": 133.5673906803131, "adapter_response": {"_message": "OK", "rows_affected": -1}, "message": "OK", "failures": null, "unique_id": "model.metro_dbt.dim_date", "compiled": true, "compiled_code": "\n\n/*\n    Gold Model: Date Dimension\n    Dynamic range:\n    - Start: 2010-01-01\n    - End:   Current year + 10 years\n*/\n\nWITH params AS (\n    SELECT\n        CAST('2010-01-01' AS DATE) AS Start_Date,\n        DATEFROMPARTS(YEAR(GETDATE()) + 10, 12, 31) AS End_Date\n),\n\nnumbers AS (\n    -- Generate enough numbers for ~200 years\n    SELECT TOP (80000)\n        ROW_NUMBER() OVER (ORDER BY (SELECT NULL)) - 1 AS n\n    FROM sys.objects a\n    CROSS JOIN sys.objects b\n),\n\ndate_base AS (\n    SELECT\n        DATEADD(DAY, n, p.Start_Date) AS Date_Value\n    FROM numbers n\n    CROSS JOIN params p\n    WHERE DATEADD(DAY, n, p.Start_Date) <= p.End_Date\n),\n\nfinal AS (\n    SELECT\n        -- Surrogate Key\n        CAST(FORMAT(Date_Value, 'yyyyMMdd') AS INT) AS Date_SK,\n\n        Date_Value,\n\n        -- Year\n        YEAR(Date_Value) AS Year,\n\n        -- Quarter\n        DATEPART(QUARTER, Date_Value) AS Quarter,\n        'Q' + CAST(DATEPART(QUARTER, Date_Value) AS VARCHAR(1)) AS Quarter_Name,\n        DATEPART(QUARTER, Date_Value) AS Quarter_Sort,\n\n        -- Month\n        MONTH(Date_Value) AS Month,\n        DATENAME(MONTH, Date_Value) AS Month_Name,\n        LEFT(DATENAME(MONTH, Date_Value), 3) AS Month_Short,\n        MONTH(Date_Value) AS Month_Sort,\n\n        -- ISO Week\n        DATEPART(ISO_WEEK, Date_Value) AS Week_Of_Year,\n\n        -- Day\n        DAY(Date_Value) AS Day_Of_Month,\n        DATEPART(WEEKDAY, Date_Value) AS Day_Of_Week,\n        DATENAME(WEEKDAY, Date_Value) AS Day_Name,\n        LEFT(DATENAME(WEEKDAY, Date_Value), 3) AS Day_Short,\n\n        -- Flags (DATEFIRST-safe)\n        CASE WHEN DATENAME(WEEKDAY, Date_Value) IN ('Saturday', 'Sunday') THEN 1 ELSE 0 END AS Is_Weekend,\n        CASE WHEN DATENAME(WEEKDAY, Date_Value) NOT IN ('Saturday', 'Sunday') THEN 1 ELSE 0 END AS Is_Weekday,\n        CASE WHEN DAY(Date_Value) = 1 THEN 1 ELSE 0 END AS Is_Month_Start,\n        CASE WHEN Date_Value = EOMONTH(Date_Value) THEN 1 ELSE 0 END AS Is_Month_End,\n\n        -- Holidays (extend via dim_holiday later)\n        CASE\n            WHEN MONTH(Date_Value) = 1 AND DAY(Date_Value) = 1 THEN 1\n            WHEN MONTH(Date_Value) = 12 AND DAY(Date_Value) = 25 THEN 1\n            ELSE 0\n        END AS Is_Holiday,\n\n        -- Fiscal (calendar-aligned)\n        YEAR(Date_Value) AS Fiscal_Year,\n        DATEPART(QUARTER, Date_Value) AS Fiscal_Quarter,\n\n        -- Grouping\n        FORMAT(Date_Value, 'yyyy-MM') AS Year_Month,\n        CAST(YEAR(Date_Value) AS VARCHAR(4)) + '-Q'\n            + CAST(DATEPART(QUARTER, Date_Value) AS VARCHAR(1)) AS Year_Quarter,\n\n        GETDATE() AS Created_TS\n    FROM date_base\n)\n\nSELECT *\nFROM final;", "relation_name": "\"MetroRetailDB\".\"Gold\".\"dim_date\"", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-12-31T05:42:40.528231Z", "completed_at": "2025-12-31T05:42:40.539568Z"}, {"name": "execute", "started_at": "2025-12-31T05:42:40.587014Z", "completed_at": "2025-12-31T05:44:54.101344Z"}], "thread_id": "Thread-2 (worker)", "execution_time": 133.59721755981445, "adapter_response": {"_message": "OK", "rows_affected": -1}, "message": "OK", "failures": null, "unique_id": "model.metro_dbt.dim_customer", "compiled": true, "compiled_code": "\n\n/*\n    Gold Model: Customer Dimension\n    Source: Silver.crm_customers_clean\n    Target: Gold.dim_customer\n\n    Provides customer master for fact_sales joins\n    PII already masked in Silver layer\n    \n    Business Rules:\n    - Customer_Key is surrogate key (auto-generated)\n    - Customer_ID is natural key\n    - One row per customer\n*/\n\nWITH source AS (\n    SELECT *\n    FROM \"MetroRetailDB\".\"Silver\".\"crm_customers_clean\"\n    WHERE Is_Valid = 1\n),\n\nfinal AS (\n    SELECT\n        -- Customer_Key will be auto-generated by SQL Server IDENTITY\n        Customer_ID,\n        Full_Name,\n        Gender,\n        Birthdate,\n        Registration_Date,\n        Email AS Email,  -- Already masked in Silver\n        Phone_Number AS Phone_Number,  -- Already masked in Silver\n        City,\n        Preferred_Channel,\n        \n        -- Metadata\n        DQ_Score,\n        GETDATE() AS Created_TS,\n        GETDATE() AS Updated_TS\n        \n    FROM source\n)\n\nSELECT * FROM final\n\n/*\n    Output Schema:\n    - Customer_Key: INT - Surrogate key (auto-generated)\n    - Customer_ID: VARCHAR(50) - Natural key\n    - Full_Name: VARCHAR(255)\n    - Gender: CHAR(1)\n    - Birthdate: DATE\n    - Registration_Date: DATE\n    - Email_Masked: VARCHAR(255)\n    - Phone_Masked: VARCHAR(50)\n    - City: VARCHAR(100)\n    - Preferred_Channel: VARCHAR(20)\n    - DQ_Score: INT\n    - Created_TS: DATETIME2\n    - Updated_TS: DATETIME2\n    \n    Note: Age and Customer_Tenure_Days are computed columns in SQL Server\n*/", "relation_name": "\"MetroRetailDB\".\"Gold\".\"dim_customer\"", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-12-31T05:42:40.623996Z", "completed_at": "2025-12-31T05:42:40.637808Z"}, {"name": "execute", "started_at": "2025-12-31T05:42:40.654912Z", "completed_at": "2025-12-31T05:44:54.101344Z"}], "thread_id": "Thread-7 (worker)", "execution_time": 133.51432919502258, "adapter_response": {"_message": "OK", "rows_affected": -1}, "message": "OK", "failures": null, "unique_id": "model.metro_dbt.dim_weather", "compiled": true, "compiled_code": "\n\n/*\n    Gold Model: Weather Dimension\n    Source: Silver.api_weather_clean\n    Target: Gold.dim_weather\n\n    Weather data for weather-sales correlation analysis\n    Grain: One row per Weather_Date + Store_ID\n    \n    Business Rules:\n    - Weather_Key is surrogate key (auto-generated)\n    - Weather_Date + Store_ID is natural key\n    - Temperature can be NULL (~2% expected)\n*/\n\nWITH source AS (\n    SELECT *\n    FROM \"MetroRetailDB\".\"Silver\".\"api_weather_clean\"\n    WHERE Is_Valid = 1\n),\n\nfinal AS (\n    SELECT\n        -- Weather_Key will be auto-generated by SQL Server IDENTITY\n        Weather_Date,\n        Store_ID,\n        Temperature_C,\n        Precipitation_mm,\n        Weather_Condition,\n        \n        -- Business flags\n        Has_Missing_Temperature,\n        Is_Extreme_Temperature,\n        \n        -- Metadata\n        DQ_Score,\n        GETDATE() AS Created_TS,\n        GETDATE() AS Updated_TS\n        \n    FROM source\n)\n\nSELECT * FROM final\n\n/*\n    Output Schema:\n    - Weather_Key: INT - Surrogate key (auto-generated)\n    - Weather_Date: DATE - Natural key (part 1)\n    - Store_ID: VARCHAR(50) - Natural key (part 2)\n    - Temperature_C: DECIMAL(5,2) - Can be NULL\n    - Precipitation_mm: DECIMAL(5,2)\n    - Weather_Condition: VARCHAR(100)\n    - Has_Missing_Temperature: BIT\n    - Is_Extreme_Temperature: BIT\n    - DQ_Score: INT\n    - Created_TS: DATETIME2\n    - Updated_TS: DATETIME2\n    \n    Note: Is_Rainy is computed column in SQL Server (Precipitation_mm > 0)\n    \n    Usage in Analysis:\n    - Join to fact_sales on Transaction_Date + Store_ID\n    - Analyze sales by weather condition\n    - Track impact of extreme weather on store performance\n*/", "relation_name": "\"MetroRetailDB\".\"Gold\".\"dim_weather\"", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2025-12-31T05:43:06.261865Z", "completed_at": "2025-12-31T05:43:06.279780Z"}, {"name": "execute", "started_at": "2025-12-31T05:43:06.281823Z", "completed_at": "2025-12-31T05:45:27.690821Z"}], "thread_id": "Thread-4 (worker)", "execution_time": 141.45283317565918, "adapter_response": {"_message": "OK", "rows_affected": -1}, "message": "OK", "failures": null, "unique_id": "model.metro_dbt.fact_sales", "compiled": true, "compiled_code": "\n\n/*\n    Gold Model: Sales Fact Table (TRANSACTION-LEVEL)\n    Sources: \n    - Silver.pos_transactions_lines_clean (line items)\n    - Silver.pos_transactions_header_clean (header)\n    Target: Gold.fact_sales\n\n    Transaction Fact Table\n    Grain: One row per transaction line (Transaction_Line_ID)\n    \n    Fact Type: TRANSACTIONAL (records individual business events)\n    Measures: ADDITIVE (can sum across all dimensions)\n    \n    Business Rules:\n    - Join lines to header for transaction context\n    - All amounts are ADDITIVE measures\n    - Supports detailed sales analysis at line level\n*/\n\nWITH lines AS (\n    SELECT *\n    FROM \"MetroRetailDB\".\"Silver\".\"pos_transactions_lines_clean\"\n    WHERE Is_Valid = 1\n),\n\nheaders AS (\n    SELECT *\n    FROM \"MetroRetailDB\".\"Silver\".\"pos_transactions_header_clean\"\n    WHERE Is_Valid = 1\n),\n\n-- Join lines with headers to get complete transaction context\nsales_with_context AS (\n    SELECT\n        -- From Lines\n        l.Transaction_Line_ID,\n        l.Transaction_ID,\n        l.Line_Number,\n        l.Product_SKU,\n        l.Store_ID,\n        l.Quantity,\n        l.Unit_Price,\n        l.Cost_Price,\n        l.Discount_Amount,\n        l.Line_Sales_Amount,\n        l.Promotion_ID,\n        \n        -- From Header\n        h.Transaction_Date,\n        h.Transaction_TS,\n        h.Customer_ID,\n        h.Payment_Method,\n        \n        -- Business Flags from Lines\n        l.Is_Return,\n        l.Is_Outlier_Quantity,\n        l.Has_Discount,\n        l.Has_Promotion,\n        \n        -- Business Flags from Header\n        h.Is_Walk_In,\n        \n        -- DQ Scores (average for context)\n        (l.DQ_Score + h.DQ_Score) / 2 AS Avg_DQ_Score\n        \n    FROM lines l\n    INNER JOIN headers h ON l.Transaction_ID = h.Transaction_ID\n    -- LEFT JOIN headers h ON l.Transaction_ID = h.Transaction_ID\n\n),\n\nfinal AS (\n    SELECT\n        -- Sales_Key will be auto-generated by SQL Server IDENTITY\n        \n        -- Degenerate Dimensions (transaction identifiers stored in fact)\n        Transaction_Line_ID,\n        Transaction_ID,\n        Line_Number,\n        \n        -- Foreign Keys (natural keys for dimension joins)\n        Transaction_Date,          -- FK to dim_date\n        Product_SKU,               -- FK to dim_product\n        Store_ID,                  -- FK to dim_store\n        Customer_ID,               -- FK to dim_customer (nullable for walk-ins)\n        COALESCE(Promotion_ID, 'N/A') AS Promotion_ID,  -- FK to dim_promotion (nullable)\n        \n        -- Measures (ADDITIVE - can sum across all dimensions)\n        Quantity,                  -- Can be negative (returns)\n        Unit_Price,\n        Cost_Price,\n        Line_Sales_Amount,         -- Revenue\n        COALESCE(Discount_Amount, 0) AS Discount_Amount,\n        \n        -- Derived Measures (calculated from base measures)\n        CAST(Quantity AS DECIMAL(18,2)) * Cost_Price AS Line_Cost_Amount,\n        Line_Sales_Amount - (CAST(Quantity AS DECIMAL(18,2)) * Cost_Price) AS Line_Margin_Amount,\n        \n        CASE \n            WHEN CAST(Quantity AS DECIMAL(18,2)) * Cost_Price > 0 \n            THEN (Line_Sales_Amount - (CAST(Quantity AS DECIMAL(18,2)) * Cost_Price)) \n                 / (CAST(Quantity AS DECIMAL(18,2)) * Cost_Price) * 100\n            ELSE 0 \n        END AS Line_Margin_Pct,\n        \n        -- Context Attributes (semi-additive or non-additive)\n        Payment_Method,\n        Transaction_TS,\n        \n        -- Business Flags\n        Is_Return,\n        Is_Outlier_Quantity,\n        Has_Discount,\n        Has_Promotion,\n        Is_Walk_In,\n        \n        -- Metadata\n        CAST(Avg_DQ_Score AS INT) AS DQ_Score,\n        GETDATE() AS Created_TS,\n        GETDATE() AS Updated_TS\n        \n    FROM sales_with_context\n)\n\nSELECT * FROM final\n\n/*\n    Output Schema:\n    - Sales_Key: INT - Surrogate key (auto-generated)\n    \n    Degenerate Dimensions:\n    - Transaction_Line_ID: VARCHAR(50) - Business key\n    - Transaction_ID: VARCHAR(50) - Parent transaction\n    - Line_Number: INT - Line sequence\n    \n    Foreign Keys (Natural Keys):\n    - Transaction_Date: DATE - FK to dim_date\n    - Product_SKU: VARCHAR(50) - FK to dim_product\n    - Store_ID: VARCHAR(50) - FK to dim_store\n    - Customer_ID: VARCHAR(50) - FK to dim_customer (nullable)\n    - Promotion_ID: VARCHAR(50) - FK to dim_promotion (nullable)\n    \n    Additive Measures:\n    - Quantity: INT - Can be negative (returns)\n    - Unit_Price: DECIMAL(18,2)\n    - Cost_Price: DECIMAL(18,2)\n    - Line_Sales_Amount: DECIMAL(18,2) - Revenue\n    - Discount_Amount: DECIMAL(18,2)\n    - Line_Cost_Amount: DECIMAL(18,2) - Calculated\n    - Line_Margin_Amount: DECIMAL(18,2) - Calculated\n    - Line_Margin_Pct: DECIMAL(18,2) - Calculated\n    \n    Context Attributes:\n    - Payment_Method: VARCHAR(20)\n    - Transaction_TS: DATETIME2\n    \n    Business Flags:\n    - Is_Return: BIT\n    - Is_Outlier_Quantity: BIT\n    - Has_Discount: BIT\n    - Has_Promotion: BIT\n    - Is_Walk_In: BIT\n    \n    Metadata:\n    - DQ_Score: INT\n    - Created_TS: DATETIME2\n    - Updated_TS: DATETIME2\n    \n    \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n    GRAIN: One row per transaction line item\n    \u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n    \n    Analysis Examples:\n    \n    1. Total Sales by Date:\n       SELECT \n           d.Date_Value,\n           d.Day_Name,\n           SUM(f.Line_Sales_Amount) AS Total_Sales,\n           SUM(f.Line_Margin_Amount) AS Total_Margin,\n           COUNT(DISTINCT f.Transaction_ID) AS Transaction_Count\n       FROM fact_sales f\n       INNER JOIN dim_date d ON f.Transaction_Date = d.Date_Value\n       GROUP BY d.Date_Value, d.Day_Name\n       ORDER BY d.Date_Value;\n    \n    2. Sales by Product Category:\n       SELECT \n           p.Category,\n           p.Sub_Category,\n           SUM(f.Quantity) AS Units_Sold,\n           SUM(f.Line_Sales_Amount) AS Total_Revenue,\n           AVG(f.Line_Margin_Pct) AS Avg_Margin_Pct\n       FROM fact_sales f\n       INNER JOIN dim_product p ON f.Product_SKU = p.Product_SKU AND p.Is_Current = 1\n       GROUP BY p.Category, p.Sub_Category\n       ORDER BY Total_Revenue DESC;\n    \n    3. Store Performance:\n       SELECT \n           s.Store_Name,\n           s.Region,\n           s.City,\n           SUM(f.Line_Sales_Amount) AS Total_Sales,\n           SUM(f.Line_Margin_Amount) AS Total_Margin,\n           COUNT(DISTINCT f.Customer_ID) AS Unique_Customers,\n           COUNT(DISTINCT f.Transaction_ID) AS Transaction_Count\n       FROM fact_sales f\n       INNER JOIN dim_store s ON f.Store_ID = s.Store_ID\n       GROUP BY s.Store_Name, s.Region, s.City\n       ORDER BY Total_Sales DESC;\n    \n    4. Customer Segmentation:\n       SELECT \n           c.City,\n           c.Preferred_Channel,\n           COUNT(DISTINCT c.Customer_ID) AS Customer_Count,\n           SUM(f.Line_Sales_Amount) AS Total_Spent,\n           AVG(f.Line_Sales_Amount) AS Avg_Transaction_Value\n       FROM fact_sales f\n       INNER JOIN dim_customer c ON f.Customer_ID = c.Customer_ID\n       WHERE f.Is_Walk_In = 0\n       GROUP BY c.City, c.Preferred_Channel;\n    \n    5. Promotion Effectiveness:\n       SELECT \n           p.Promo_Name,\n           p.Promo_Type,\n           COUNT(DISTINCT f.Transaction_ID) AS Transaction_Count,\n           SUM(f.Line_Sales_Amount) AS Promo_Sales,\n           SUM(f.Discount_Amount) AS Total_Discount,\n           SUM(f.Line_Margin_Amount) AS Net_Margin\n       FROM fact_sales f\n       INNER JOIN dim_promotion p ON f.Promotion_ID = p.Promotion_ID\n       WHERE f.Has_Promotion = 1\n       GROUP BY p.Promo_Name, p.Promo_Type\n       ORDER BY Promo_Sales DESC;\n    \n    6. Weather Impact on Sales:\n       SELECT \n           w.Weather_Condition,\n           w.Temperature_C,\n           COUNT(DISTINCT f.Transaction_ID) AS Transaction_Count,\n           SUM(f.Line_Sales_Amount) AS Total_Sales,\n           AVG(f.Line_Sales_Amount) AS Avg_Line_Value\n       FROM fact_sales f\n       INNER JOIN dim_weather w ON f.Transaction_Date = w.Weather_Date \n                                 AND f.Store_ID = w.Store_ID\n       INNER JOIN dim_date d ON f.Transaction_Date = d.Date_Value\n       WHERE d.Year = 2024\n       GROUP BY w.Weather_Condition, w.Temperature_C\n       ORDER BY Total_Sales DESC;\n    \n    7. Returns Analysis:\n       SELECT \n           d.Year_Month,\n           p.Category,\n           COUNT(*) AS Return_Count,\n           SUM(f.Line_Sales_Amount) AS Return_Amount,\n           SUM(f.Quantity) AS Return_Quantity\n       FROM fact_sales f\n       INNER JOIN dim_date d ON f.Transaction_Date = d.Date_Value\n       INNER JOIN dim_product p ON f.Product_SKU = p.Product_SKU AND p.Is_Current = 1\n       WHERE f.Is_Return = 1\n       GROUP BY d.Year_Month, p.Category\n       ORDER BY d.Year_Month, Return_Amount DESC;\n*/", "relation_name": "\"MetroRetailDB\".\"Gold\".\"fact_sales\"", "batch_results": null}], "elapsed_time": 167.56199669837952, "args": {"print": true, "project_dir": "C:\\Work\\Projects\\MetroRetail\\dbt\\metro_dbt", "state_modified_compare_vars": false, "log_format_file": "debug", "use_colors_file": true, "quiet": false, "send_anonymous_usage_stats": true, "validate_macro_args": false, "invocation_command": "dbt run --select gold.* --full-refresh", "exclude": [], "defer": false, "macro_debugging": false, "require_batched_execution_for_custom_microbatch_strategy": false, "which": "run", "require_nested_cumulative_type_params": false, "profiles_dir": "C:\\Work\\Projects\\MetroRetail\\dbt\\metro_dbt", "log_level": "info", "partial_parse": true, "require_yaml_configuration_for_mf_time_spines": false, "full_refresh": true, "state_modified_compare_more_unrendered_values": false, "upload_to_artifacts_ingest_api": false, "log_path": "C:\\Work\\Projects\\MetroRetail\\dbt\\metro_dbt\\logs", "partial_parse_file_diff": true, "log_level_file": "debug", "populate_cache": true, "strict_mode": false, "show_resource_report": false, "cache_selected_only": false, "printer_width": 80, "require_explicit_package_overrides_for_builtin_materializations": true, "empty": false, "introspect": true, "static_parser": true, "write_json": true, "use_fast_test_edges": false, "log_format": "default", "warn_error_options": {"error": [], "warn": [], "silence": []}, "source_freshness_run_project_hooks": true, "indirect_selection": "eager", "require_all_warnings_handled_by_warn_error": false, "favor_state": false, "require_generic_test_arguments_property": true, "show_all_deprecations": false, "log_file_max_bytes": 10485760, "select": ["gold.*"], "use_colors": true, "vars": {}, "require_resource_names_without_spaces": true, "version_check": true, "skip_nodes_if_on_run_start_fails": false}}